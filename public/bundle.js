(()=>{"use strict";const e={id:void 0,_username:void 0,get username(){return this._username},set username(e){this._username=e,document.getElementById("top-username").innerHTML=e},set(e){for(let[t,s]of Object.entries(e))this[t]=s}};class t{constructor(e){return this.box=this.createBox(e),this.box.self||this.box.append(this.createSpan("username")),["messageBody","time"].forEach((e=>{this.box.append(this.createSpan(e))})),this.box}createBox(t){let s=document.createElement("div"),n=new Date(t.time);return s.messageObj=t,s.id=t.id,s.className="message",s.self=t.senderId===e.id,s.self&&s.classList.add("self"),s.username=t.sender,s.messageBody=t.text,s.time=`${("0"+n.getHours()).slice(-2)}:${("0"+n.getMinutes()).slice(-2)}`,s}createSpan(e){let t=document.createElement("span");return t.className=e,t.innerHTML=this.box[e],"username"===e&&(t.title=this.box[e]),t}}class s{constructor(e,t=!1){t=t||this._ifBottom(),e(),t&&this.constructor.scroll()}_ifBottom(){let e=Math.ceil(n.scrollTop),t=n.clientHeight;return n.scrollHeight<=e+t}static scroll(){n.scrollTop=n.scrollHeight}static ifNotFirstPage(e){return e.scrollHeight-e.scrollTop>2*e.clientHeight}}const n=document.querySelector(".message-container"),o={list:new Array,new(e){let s=new t(e);if(this.list=this.list.filter((t=>t.messageObj.id!==e.id||(n.removeChild(t),!1))),!this.list.length)return n.append(s),this.list.push(s);this.list.find(((t,n)=>{if(t.messageObj.time<e.time)return t.after(s),this.list.splice(n,0,s),!0})),this.save()},save(){let e=this.list.map((e=>e.messageObj));sessionStorage.history=JSON.stringify(e.slice(0,100))},load(){let e="history"in sessionStorage&&JSON.parse(sessionStorage.history);e&&(n.innerHTML="",e.reverse().forEach(((e,s,o)=>{let i=new t(e);n.append(i),o[s]=i})),this.list=e.slice().reverse(),s.scroll())}},i=io(),r=document.forms.inputForm;let l=r.elements.input;function a(e){return!e||/^\s*$/.test(e)}function c(){let e=function(){let e;for(;a(e);)e=prompt("Pick username");return e}();i.emit("add user",{username:e})}function u(t){t.preventDefault();let s=l.value;if(!a(s)){let t=Date.now(),n={id:`${e.id}:${t.toString().slice(-9)}`,sender:e.username,senderId:e.id,text:s,time:t};i.emit("message",n),m(n,!0),l.value=""}}function m(e,t=!1){new s((()=>{o.new(e)}),t),console.log(n.scrollTop)}r.addEventListener("submit",u),l.onkeyup=function(e){e.ctrlKey&&"Enter"===e.code&&u(e)},n.onscroll=function(e,t){let s=!1;return function(){s||(e.apply(this,arguments),s=!0,setTimeout((()=>{s=!1}),100))}}((e=>{!function(e){let t=e.target;s.ifNotFirstPage(t)?t.classList.add("to-bottom"):t.classList.remove("to-bottom")}(e)})),document.addEventListener("DOMContentLoaded",(()=>{!function(){let e=sessionStorage.username,t=sessionStorage.id;t&&e?i.emit("add user",{username:e,id:t}):c()}()})),document.documentElement.setAttribute("class","ontouchend"in document?"touch":"no-touch"),i.on("connect",(()=>{console.log("You're connected")})),i.on("connect_error",(e=>{console.log(`connect_error due to ${e.message}`)})),i.on("successfully added",(t=>{sessionStorage.setItem("username",t.username),sessionStorage.setItem("id",t.id),e.set(t),o.load(),console.log(`Username: ${e.username}\nId: ${e.id}`)})),i.on("can't add user",(e=>{e&&alert(e),c()})),i.on("new user",(e=>{document.getElementById("user-count").innerHTML=e})),i.on("message",m)})();