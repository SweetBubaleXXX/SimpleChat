(()=>{"use strict";const e={username:void 0,id:void 0,set(e){for(let[t,s]of Object.entries(e))this[t]=s}};class t{constructor(e){return this.box=this.createBox(e),this.box.self||this.box.append(this.createSpan("username")),["messageBody","time"].forEach((e=>{this.box.append(this.createSpan(e))})),this.box}createBox(t){let s=document.createElement("div"),n=new Date(t.time);return s.messageObj=t,s.id=t.id,s.className="message",s.self=t.senderId===e.id,s.self&&s.classList.add("self"),s.username=t.sender,s.messageBody=t.text,s.time=`${("0"+n.getHours()).slice(-2)}:${("0"+n.getMinutes()).slice(-2)}`,s}createSpan(e){let t=document.createElement("span");return t.className=e,t.innerHTML=this.box[e],"username"===e&&(t.title=this.box[e]),t}}class s{constructor(e,t=!1){t=t||this._ifBottom(),e(),t&&this.constructor.scroll()}_ifBottom(){let e=Math.ceil(n.scrollTop),t=n.clientHeight;return n.scrollHeight<=e+t}static scroll(){n.scrollTop=n.scrollHeight}}const n=document.querySelector(".message-container"),i={list:new Array,new(e){let s=new t(e);if(this.list=this.list.filter((t=>t.messageObj.id!==e.id||(n.removeChild(t),!1))),!this.list.length)return n.append(s),this.list.push(s);this.list.find(((t,n)=>{if(t.messageObj.time<e.time)return t.after(s),this.list.splice(n,0,s),!0})),this.save()},save(){let e=this.list.map((e=>e.messageObj));sessionStorage.history=JSON.stringify(e.slice(0,100))},load(){let e="history"in sessionStorage&&JSON.parse(sessionStorage.history);e&&(n.innerHTML="",e.reverse().forEach(((e,s,i)=>{let o=new t(e);n.append(o),i[s]=o})),this.list=e.slice().reverse(),s.scroll())}},o=io(),r=document.forms.inputForm;let a=r.elements.input;function l(e){return!e||/^\s*$/.test(e)}function c(){let e=function(){let e;for(;l(e);)e=prompt("Pick username");return e}();o.emit("add user",{username:e})}function d(t){t.preventDefault();let s=a.value;if(!l(s)){let t=Date.now(),n={id:`${e.id}:${t.toString().slice(-9)}`,sender:e.username,senderId:e.id,text:s,time:t};o.emit("message",n),u(n,!0),a.value=""}}function u(e,t=!1){new s((()=>{i.new(e)}),t)}r.addEventListener("submit",d),a.onkeyup=function(e){e.ctrlKey&&"Enter"===e.code&&d(e)},document.addEventListener("DOMContentLoaded",(()=>{!function(){let e=sessionStorage.username,t=sessionStorage.id;t&&e?o.emit("add user",{username:e,id:t}):c()}()})),document.documentElement.setAttribute("class","ontouchend"in document?"touch":"no-touch"),o.on("connect",(()=>{console.log("You're connected")})),o.on("connect_error",(e=>{console.log(`connect_error due to ${e.message}`)})),o.on("successfully added",(t=>{sessionStorage.setItem("username",t.username),sessionStorage.setItem("id",t.id),e.set(t),i.load(),console.log(`Username: ${e.username}\nId: ${e.id}`)})),o.on("can't add user",(e=>{e&&alert(e),c()})),o.on("message",u)})();